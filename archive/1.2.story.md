# Story 1.2: Backend API for Site Performance Data

## Status
**Done**

## Story
**As the** Frontend Application,
**I want** a public API endpoint to retrieve the time-series performance data for a specific site,
**so that** I can display it on a power curve.

## Acceptance Criteria
1. An API endpoint `GET /api/sites/{site_id}/performance` is created.
2. The endpoint accepts `site_id`, `start_date`, and `end_date` as parameters.
3. The endpoint connects to AWS Redshift and retrieves `timestamp`, actual power, and expected power data.
4. The endpoint correctly filters the data to only include records where inverter availability is 100%.
5. The endpoint returns the data in a valid JSON format.

## Tasks / Subtasks
- [ ] In `packages/shared-types`, define or update the TypeScript interface for the API response payload.
- [ ] In the `apps/api` project, create a new router file (e.g., `apps/api/app/routers/sites.py`).
- [ ] In the new router, implement the `GET /sites/{site_id}/performance` endpoint using FastAPI.
- [ ] In the Data Access Layer (DAL), create a new function to handle the Redshift query for site performance.
- [ ] The DAL function must accept `site_id`, `start_date`, and `end_date` as parameters.
- [ ] The SQL query within the DAL must select the required columns and correctly filter by `site_id`, the date range, and `inverter_availability = 1`.
- [ ] Write unit tests with Pytest for the new API endpoint and the DAL function.

## Dev Notes
The developer must adhere to the following architectural patterns.
**Note**: User authentication is not required for the MVP. This endpoint should be public.

### API Specification
* **Method**: `GET`
* **Path**: `/api/sites/{site_id}/performance`
* **Purpose**: Get detailed time-series performance data for a specific site.


### Backend Implementation Pattern
Use the established FastAPI and Data Access Layer (DAL) patterns. The route logic should be minimal, calling the DAL to handle all database interaction.
```python
# apps/api/app/routers/sites.py
from fastapi import APIRouter
# ... other imports

router = APIRouter()

@router.get("/sites/{site_id}/performance")
def get_site_performance(site_id: str, start_date: str, end_date: str):
    # 1. Validate input parameters
    # 2. Call the Data Access Layer function to query Redshift
    #    e.g., performance_data = dal.get_performance_for_site(...)
    # 3. Format and return the data
    pass
````

### Optimized Query Structure

The SQL query in the DAL should follow the optimized pattern to ensure performance.

```sql
SELECT 
  DATE_TRUNC('hour', timestamp) AS hour,
  AVG(power_ac) AS avg_power,
  AVG(poa_irradiance) AS avg_irradiance
FROM inverter_telemetry
WHERE site_id = :site_id -- Use bound parameters
  AND timestamp >= :start_date 
  AND timestamp < :end_date
  AND inverter_availability = 1
GROUP BY 1
ORDER BY 1;
```

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-07-29 | 1.0 | Story created | Bob (SM) |

## Dev Agent Record

  * **Agent Model Used**: Gemini 1.5 Pro
  * **Completion Notes List**:
      - Backend API for site performance is complete and tested.
      - DAL pattern was used to isolate the Redshift query.
      - Endpoint is public as per MVP requirements (no authentication).
  * **File List**:
      - `MODIFIED: packages/shared-types/index.ts`
      - `MODIFIED: apps/api/app/routers/sites.py` *(QA added input validation)*
      - `NEW: apps/api/app/dal/performance_dal.py`
      - `MODIFIED: apps/api/app/main.py`
      - `NEW: apps/api/tests/test_sites_router.py`

## QA Results



### Final Status

