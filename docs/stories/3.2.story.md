# Story 3.2: AI Assistant Chat UI

## Status
Ready for Review

## Story
**As a** Solar Asset Manager,
**I want** a persistent chat interface,
**so that** I can ask diagnostic questions from anywhere in the application.

## Acceptance Criteria
1. A chat icon is persistent in the bottom-right corner.
2. Clicking opens a chat panel.
3. User can type and submit questions.
4. The panel displays the conversation.
5. It can render visualizations returned by the AI.

## Tasks / Subtasks
- [x] **Frontend**: Create persistent chat icon component in bottom-right corner (AC: 1)
  - [x] Create `ChatIcon` component using ShadCN/UI components
  - [x] Position using fixed positioning in bottom-right corner
  - [x] Add hover and click states
- [x] **Frontend**: Implement expandable chat panel component (AC: 2)
  - [x] Create `ChatPanel` component with slide-in animation
  - [x] Implement show/hide state management using Zustand
  - [x] Add proper z-index layering for overlay behavior
- [x] **Frontend**: Build chat input and message interface (AC: 3, 4)
  - [x] Create `ChatInput` component with text area and send button
  - [x] Create `ChatMessage` component for displaying conversation
  - [x] Implement conversation history state management
  - [x] Add loading states during API calls
- [x] **Frontend**: Integrate with AI Assistant API (AC: 3, 4)
  - [x] Use TanStack Query for API calls to `/api/query` endpoint
  - [x] Handle API response and error states
  - [x] Parse and display AI response summaries
- [x] **Frontend**: Implement visualization rendering (AC: 5)
  - [x] Parse chart data from AI API responses
  - [x] Render charts using existing chart components from portfolio page
  - [x] Handle different chart types (scatter, bar, multi-scatter)
- [x] **Testing**: Create comprehensive test suite
  - [x] Unit tests for all components using Jest & RTL
  - [x] Test chat functionality and API integration
  - [x] Test visualization rendering edge cases

## Dev Notes

### Previous Story Insights
From Story 3.1, the AI Assistant backend API is fully functional with:
- POST /api/query endpoint available
- Natural language processing for 5 predefined diagnostic questions
- Structured JSON responses with summary and optional chart data
- Chart types supported: "scatter", "bar", "multi-scatter"
- Response format: `{summary: string, data: object, chart_type: string, columns: string[]}`

### Component Specifications
Based on existing frontend architecture [Source: architecture/9-frontend-architecture.md]:
- **State Management**: Use Zustand for global client-side state management
- **Data Fetching**: Use TanStack Query (React Query) for managing server state
- **Component Organization**: Feature-based structure - create in `components/features/chat/`
- **UI Components**: Use ShadCN/UI component toolkit for consistent styling

### File Locations
Based on current project structure:
- **Chat Components**: `apps/frontend/src/components/features/chat/`
  - `ChatIcon.tsx` - Persistent bottom-right icon
  - `ChatPanel.tsx` - Main chat interface panel
  - `ChatInput.tsx` - Input component for typing messages  
  - `ChatMessage.tsx` - Individual message display
  - `ChatVisualization.tsx` - Chart rendering component
- **State Management**: `apps/frontend/src/lib/stores/chatStore.ts` (Zustand store)
- **API Integration**: Extend existing `apps/frontend/src/lib/api/sites.ts` with AI query function
- **Types**: Add to `apps/frontend/src/types/` for chat-related interfaces

### API Integration Details
From Story 3.1 implementation:
- **Endpoint**: `POST /api/query`
- **Request Format**: `{query: string}` (1-1000 characters, validated)
- **Response Format**: `{summary: string, data?: object, chart_type?: string, columns?: string[]}`
- **Error Handling**: 400 for validation errors, 500 for server errors
- **Integration**: Use existing API patterns from `sites.ts`

### Technical Constraints
[Source: architecture/3-tech-stack.md]:
- **Frontend Framework**: Next.js 14+ with TypeScript 5.4+
- **UI Components**: ShadCN/UI latest version
- **Styling**: Follow existing Tailwind CSS patterns
- **Testing**: Jest & RTL for component testing

### Chart Integration
Reuse existing chart components from portfolio page:
- Located in `apps/frontend/src/app/portfolio/[siteId]/page.tsx`
- Uses Recharts library (ComposedChart, Scatter, Line, etc.)
- Support for same chart types returned by AI API

### Security Considerations
- Input validation on frontend (complement backend validation)
- Sanitize user input before API calls
- Handle API errors gracefully without exposing sensitive information
- Follow existing security patterns from current codebase

## Testing
Based on testing strategy [Source: architecture/15-testing-strategy.md]:
- **Unit Tests**: Jest & RTL for all React components
- **Test Location**: `apps/frontend/src/components/features/chat/__tests__/`
- **Coverage Requirements**: Follow testing pyramid - comprehensive unit tests
- **Integration Tests**: Test API integration with mock responses
- **Test Patterns**: Follow existing test patterns from portfolio page tests

Test scenarios to cover:
- Chat icon visibility and click behavior
- Panel show/hide animations and state
- Message input and submission
- API response handling and error states
- Visualization rendering for different chart types
- Conversation history persistence during session

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-04 | 1.0 | Story created | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Implementation Summary
Successfully implemented all Story 3.2 requirements for the AI Assistant Chat UI. Created a complete chat interface with persistent icon, expandable panel, conversation management, and visualization rendering capabilities.

### Files Created/Modified

#### New Files Created:
- `apps/frontend/src/types/chat.ts` - TypeScript interfaces for chat functionality
- `apps/frontend/src/lib/stores/chatStore.ts` - Zustand store for chat state management
- `apps/frontend/src/components/features/chat/ChatIcon.tsx` - Persistent chat icon component
- `apps/frontend/src/components/features/chat/ChatPanel.tsx` - Main chat panel with animations
- `apps/frontend/src/components/features/chat/ChatInput.tsx` - Input component with validation
- `apps/frontend/src/components/features/chat/ChatMessage.tsx` - Message display component
- `apps/frontend/src/components/features/chat/ChatVisualization.tsx` - Chart rendering component
- `apps/frontend/src/components/features/chat/index.tsx` - Feature export file

#### Modified Files:
- `apps/frontend/src/lib/api/sites.ts` - Extended API client with AI query functionality
- `apps/frontend/src/app/layout.tsx` - Integrated chat components globally
- `apps/frontend/package.json` - Added Zustand dependency

#### Test Files Created:
- `apps/frontend/src/components/features/chat/__tests__/ChatIcon.test.tsx`
- `apps/frontend/src/components/features/chat/__tests__/ChatPanel.test.tsx`
- `apps/frontend/src/components/features/chat/__tests__/ChatInput.test.tsx`
- `apps/frontend/src/components/features/chat/__tests__/ChatMessage.test.tsx`
- `apps/frontend/src/components/features/chat/__tests__/ChatVisualization.test.tsx`
- `apps/frontend/src/components/features/chat/__tests__/chatStore.test.ts`

### Technical Implementation Details

#### State Management
- Implemented Zustand store for global chat state
- Manages chat open/close state, message history, and loading states
- Provides actions for message management and UI control

#### API Integration
- Extended existing API client with `queryAI` method
- Integrated with TanStack Query for optimal caching and error handling
- Supports full AI API contract from Story 3.1 including visualizations

#### UI Components
- **ChatIcon**: Fixed-position button with smooth animations and hover effects
- **ChatPanel**: Slide-in panel with auto-scroll and proper z-indexing
- **ChatInput**: Text area with character counting, validation, and keyboard shortcuts
- **ChatMessage**: Message bubbles with timestamps and visualization support
- **ChatVisualization**: Recharts integration supporting scatter, bar, and multi-scatter charts

#### Validation Results
- ✅ TypeScript compilation: Passed
- ✅ ESLint linting: Passed (only existing warnings from other files)
- ✅ Build process: Successful
- ✅ Test coverage: 46 passing tests across 6 test suites

### Completion Notes
All acceptance criteria have been implemented and tested:
1. ✅ Persistent chat icon in bottom-right corner
2. ✅ Expandable chat panel on click
3. ✅ Message input and submission functionality
4. ✅ Conversation display with proper formatting
5. ✅ Visualization rendering for AI responses with chart data

The implementation follows all coding standards, uses existing patterns from the codebase, and provides comprehensive test coverage. The chat interface is fully functional and ready for integration testing.

## QA Results
*This section to be filled out by the QA Agent during review.*