Certainly. Here is the clean, "Draft" version of **Story 2.1**, as it would be presented to a developer before any work begins.

-----

### **Story 2.1: Backend API for Skid & Inverter Data (Draft Version)**

````markdown
# Story 2.1: Backend API for Skid & Inverter Data

## Status
Draft

## Story
**As the** Frontend Application,
**I want** new API endpoints to retrieve performance data for all skids on a site and all inverters on a skid,
**so that** I can populate the drill-down views.

## Acceptance Criteria
1. A new API endpoint `GET /api/sites/{site_id}/skids` is created to return a list of skids and their aggregate performance metrics for a given time range.
2. A new API endpoint `GET /api/skids/{skid_id}/inverters` is created to return a list of inverters and their individual performance metrics.
3. Both endpoints correctly apply the 100% availability filter when calculating metrics.
4. The API responses are optimized for speed and include all data necessary for the UI to render the next level of the hierarchy.

## Tasks / Subtasks
- [ ] **Backend**: In the `apps/api/app/routers/sites.py` file, add a new endpoint `GET /sites/{site_id}/skids`.
- [ ] **Backend**: In the DAL, create a function that queries Redshift for aggregated performance data for all skids on a given site, grouped by `skid_id`.
- [ ] **Backend**: Create a new router file for skids (e.g., `apps/api/app/routers/skids.py`).
- [ ] **Backend**: In the new skid router, implement the `GET /skids/{skid_id}/inverters` endpoint.
- [ ] **Backend**: In the DAL, create a function that queries Redshift for performance data for all inverters on a given skid.
- [ ] **Backend**: Ensure both DAL functions correctly filter by `inverter_availability = 1`.
- [ ] **Backend**: Write Pytest unit tests for both new endpoints and their corresponding DAL functions.

## Dev Notes
The developer must extend the existing API and DAL patterns.

### API Specifications
* **`GET /api/sites/{site_id}/skids`**:
    * **Purpose**: Get a list of all skids for a site with their aggregate performance (e.g., average deviation, total power).
* **`GET /api/skids/{skid_id}/inverters`**:
    * **Purpose**: Get a list of all inverters for a skid with their individual performance.


### Optimized Query Structure
The DAL functions should use `GROUP BY` clauses to have Redshift perform the aggregations, which is highly efficient.

**Example Query for Skids:**
```sql
SELECT
  skid_id,
  AVG(power_ac) as avg_power -- etc.
FROM inverter_telemetry
WHERE site_id = :site_id
  AND timestamp >= :start_date 
  AND timestamp < :end_date
  AND inverter_availability = 1
GROUP BY skid_id;
````

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-07-29 | 1.0 | Story created | Bob (SM) |

## Dev Agent Record

*This section to be filled out by the Developer Agent during implementation.*

## QA Results

*This section to be filled out by the QA Agent during review.*
