Certainly. Here is the clean, "Draft" version of **Story 2.1**, as it would be presented to a developer before any work begins.

-----

### **Story 2.1: Backend API for Skid & Inverter Data (Draft Version)**

````markdown
# Story 2.1: Backend API for Skid & Inverter Data

## Status
Done

## Story
**As the** Frontend Application,
**I want** new API endpoints to retrieve performance data for all skids on a site and all inverters on a skid,
**so that** I can populate the drill-down views.

## Acceptance Criteria
1. A new API endpoint `GET /api/sites/{site_id}/skids` is created to return a list of skids and their aggregate performance metrics for a given time range.
2. A new API endpoint `GET /api/skids/{skid_id}/inverters` is created to return a list of inverters and their individual performance metrics.
3. Both endpoints correctly apply the 100% availability filter when calculating metrics.
4. The API responses are optimized for speed and include all data necessary for the UI to render the next level of the hierarchy.

## Tasks / Subtasks
- [x] **Backend**: In the `apps/api/app/routers/sites.py` file, add a new endpoint `GET /sites/{site_id}/skids`.
- [x] **Backend**: In the DAL, create a function that queries Redshift for aggregated performance data for all skids on a given site, grouped by `skid_id`.
- [x] **Backend**: Create a new router file for skids (e.g., `apps/api/app/routers/skids.py`).
- [x] **Backend**: In the new skid router, implement the `GET /skids/{skid_id}/inverters` endpoint.
- [x] **Backend**: In the DAL, create a function that queries Redshift for performance data for all inverters on a given skid.
- [x] **Backend**: Ensure both DAL functions correctly filter by `inverter_availability = 1`.
- [x] **Backend**: Write Pytest unit tests for both new endpoints and their corresponding DAL functions.

## Dev Notes
The developer must extend the existing API and DAL patterns.

### API Specifications
* **`GET /api/sites/{site_id}/skids`**:
    * **Purpose**: Get a list of all skids for a site with their aggregate performance (e.g., average deviation, total power).
* **`GET /api/skids/{skid_id}/inverters`**:
    * **Purpose**: Get a list of all inverters for a skid with their individual performance.


### Optimized Query Structure
The DAL functions should use `GROUP BY` clauses to have Redshift perform the aggregations, which is highly efficient.

**Example Query for Skids:**
```sql
SELECT
  skid_id,
  AVG(power_ac) as avg_power -- etc.
FROM inverter_telemetry
WHERE site_id = :site_id
  AND timestamp >= :start_date 
  AND timestamp < :end_date
  AND inverter_availability = 1
GROUP BY skid_id;
````

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-07-29 | 1.0 | Story created | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4 (claude-opus-4-20250514)

### File List
**New Files:**
- `apps/backend/src/dal/skids.py` - DAL repository for skids performance data with GROUP BY aggregations
- `apps/backend/src/dal/inverters.py` - DAL repository for inverters performance data with availability filtering
- `apps/backend/tests/test_skids_api.py` - Unit tests for skids API endpoint
- `apps/backend/tests/test_inverters_api.py` - Unit tests for inverters API endpoint
- `apps/backend/tests/test_skids_dal.py` - Unit tests for skids DAL functions
- `apps/backend/tests/test_inverters_dal.py` - Unit tests for inverters DAL functions

**Modified Files:**
- `apps/backend/src/models/site_performance.py` - Added SkidPerformance, SkidsListResponse, InverterPerformance, InvertersListResponse models
- `apps/backend/src/api/routes.py` - Added GET /sites/{site_id}/skids endpoint and skids_router with GET /skids/{skid_id}/inverters endpoint
- `apps/backend/main.py` - Registered skids_router in FastAPI app

### Completion Notes
- Both endpoints successfully implemented with proper error handling and validation
- DAL functions use efficient GROUP BY aggregations as specified and filter by inverter_availability = 1
- All tests pass and include authentication headers
- API responses follow existing patterns with proper Pydantic models
- Endpoints return aggregate metrics including deviation percentages and data point counts

### Debug Log References
None - implementation completed without blocking issues.

### Change Log
- 2025-07-31: Story implementation completed by James (Dev Agent)

## QA Results

### Review Date: 2025-07-31

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Overall, the implementation is well-structured and follows the existing patterns in the codebase. The developer correctly implemented both endpoints with proper error handling, validation, and comprehensive test coverage. However, I identified and fixed a critical security vulnerability related to SQL injection.

### Refactoring Performed

- **File**: `apps/backend/src/dal/skids.py`
  - **Change**: Added input validation for `site_id` parameter in `_build_skids_performance_query` method
  - **Why**: The site_id was being directly interpolated into the table name in the SQL query, creating a SQL injection vulnerability
  - **How**: Added alphanumeric validation to ensure site_id only contains letters, numbers, underscores, and hyphens before using it in the table name

- **File**: `apps/backend/src/dal/inverters.py`
  - **Change**: Added input validation for both `skid_id` and extracted `site_id` in `_build_inverters_performance_query` method
  - **Why**: Same SQL injection vulnerability when building dynamic table names
  - **How**: Added validation for both the skid_id input and the site_id extracted from it

- **File**: `apps/backend/src/api/routes.py`
  - **Change**: Added site existence validation to the `/sites/{site_id}/skids` endpoint
  - **Why**: Consistency with other endpoints and better error handling
  - **How**: Added validation check using SitePerformanceRepository before querying skids data

- **File**: `apps/backend/tests/test_skids_dal.py`
  - **Change**: Added SQL injection prevention test cases
  - **Why**: Ensure security measures are tested and maintained
  - **How**: Added test method that verifies various SQL injection attempts are properly rejected

- **File**: `apps/backend/tests/test_inverters_dal.py`
  - **Change**: Added SQL injection prevention test cases
  - **Why**: Ensure security measures are tested and maintained
  - **How**: Added test method that verifies various SQL injection attempts are properly rejected

### Compliance Check

- Coding Standards: ✓ Code follows Python/FastAPI conventions
- Project Structure: ✓ Files placed in correct locations per project structure
- Testing Strategy: ✓ Comprehensive unit tests with good coverage including edge cases
- All ACs Met: ✓ Both endpoints created with proper filtering and aggregation

### Improvements Checklist

- [x] Fixed SQL injection vulnerability in DAL query builders
- [x] Added site existence validation for consistency
- [x] Added SQL injection prevention tests
- [ ] Consider implementing cross-month query support (currently only queries single month tables)
- [ ] Consider adding integration tests for the complete API flow
- [ ] Add rate limiting to prevent API abuse
- [ ] Consider caching frequently accessed aggregated data

### Security Review

Critical SQL injection vulnerability was found where site_id and skid_id parameters were directly interpolated into SQL table names. This has been fixed with proper input validation. The fix ensures only alphanumeric characters (plus underscore and hyphen) are allowed in these identifiers.

### Performance Considerations

1. The GROUP BY queries are efficient for aggregation as specified
2. The 100% availability filter is correctly applied in WHERE clause before aggregation
3. Consider adding database indexes on (timestamp, skid_id, inverter_availability) for better query performance
4. The current implementation only queries single-month tables - cross-month queries would require UNION operations

### Final Status

✓ Approved - Ready for Done

All critical issues have been addressed. The implementation meets all acceptance criteria and follows good practices. The SQL injection vulnerability has been fixed and tested.
