# Story 3.1: Backend API for AI Assistant

## Status
Draft

## Story
**As the** Frontend Application,
**I want** a single API endpoint that can process natural language queries,
**so that** I can provide users with AI-driven diagnostic answers.

## Acceptance Criteria
1. A new API endpoint `POST /api/query` is created.
2. The endpoint accepts a JSON payload containing a natural language string (the user's question).
3. The backend logic translates the natural language query into an appropriate SQL query for Redshift.
4. The endpoint returns a structured JSON response containing a text summary, and optionally, data for a chart or table.
5. The endpoint can successfully process and provide accurate answers for the five predefined MVP diagnostic questions.

## Tasks / Subtasks
- [ ] **Backend**: In the `apps/api` project, create a new router file for the AI service (e.g., `apps/api/app/routers/ai.py`).
- [ ] **Backend**: In the new router, implement the `POST /api/query` endpoint.
- [ ] **Backend**: Create a new service module for the AI logic (e.g., `apps/api/app/services/ai_service.py`).
- [ ] **Backend**: In the AI service, implement a function to parse the incoming natural language query. For the MVP, this can be a keyword-based parser.
- [ ] **Backend**: The parser must be able to identify which of the five predefined questions is being asked and extract any necessary parameters (e.g., Site Name, Dates).
- [ ] **Backend**: Based on the identified question, the AI service will call the appropriate function(s) in the Data Access Layer (DAL) to get the required data.
- [ ] **Backend**: Implement logic to synthesize the fetched data into a human-readable text summary.
- [ ] **Backend**: Write Pytest unit tests for the AI service, testing its ability to correctly parse and answer each of the five predefined questions.

## Dev Notes
The developer must create the backend logic for the AI assistant.
**MVP Scope Clarification**: A complex Natural Language Processing (NLP) model is not required for the MVP. The backend should use a simpler method, like keyword matching or regex, to recognize and handle the five specific questions defined below.

### API Specification
* **`POST /api/query`**:
    * **Purpose**: Send a natural language question from the user to the AI assistant for processing.


### Five Predefined MVP Diagnostic Questions to Support
1.  "Show me the power curve for **[Site Name]** for **[Time Range]** and highlight periods of significant underperformance."
2.  "Which skids and inverters at **[Site Name]** showed the worst performance against the model **[Time Range]**?"
3.  "Generate the individual power curve for inverter **[Inverter ID]** at **[Site Name]** for the **[Time Range]**."
4.  "What were the RMSE and R-squared values between the actual and expected power for **[Site Name]** **[Time Range]**?"
5.  "Compare the power curves for **[Skid A ID]** and **[Skid B ID]** at **[Site Name]** for **[Time Range]**."


## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-07-29 | 1.0 | Story created | Bob (SM) |

## Dev Agent Record
*This section to be filled out by the Developer Agent during implementation.*

## QA Results
*This section to be filled out by the QA Agent during review.*